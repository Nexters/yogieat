name: Development Deployment

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      deploy_client:
        description: 'Deploy client container'
        required: false
        default: true
        type: boolean
      deploy_nginx:
        description: 'Deploy nginx container'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'Force rebuild (for secret changes)'
        required: false
        default: true
        type: boolean

concurrency:
  group: deploy-${{ github.repository }}
  cancel-in-progress: false

jobs:
  build-image:
    runs-on: ubuntu-latest
    environment:
      name: development
    outputs:
      nginx_changed: ${{ steps.changes.outputs.nginx }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Detect changed files
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            client:
              - 'app/**'
              - 'src/**'
              - 'public/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'docker/client/**'
              - 'next.config.js'
            nginx:
              - 'docker/nginx/**'

      - name: Set deployment flags for manual trigger
        if: github.event_name == 'workflow_dispatch'
        id: manual_flags
        run: |
          echo "client=${{ github.event.inputs.deploy_client }}" >> $GITHUB_OUTPUT
          echo "nginx=${{ github.event.inputs.deploy_nginx }}" >> $GITHUB_OUTPUT

      - name: Login to DockerHub
        if: |
          (github.event_name == 'push' && (steps.changes.outputs.client == 'true' || steps.changes.outputs.nginx == 'true')) ||
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_client == 'true' || github.event.inputs.deploy_nginx == 'true'))
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        if: |
          (github.event_name == 'push' && (steps.changes.outputs.client == 'true' || steps.changes.outputs.nginx == 'true')) ||
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_client == 'true' || github.event.inputs.deploy_nginx == 'true'))
        uses: docker/setup-buildx-action@v3

      - name: Create .env.production
        if: |
          (github.event_name == 'push' && steps.changes.outputs.client == 'true') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_client == 'true')
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > .env.production
          echo "NEXT_PUBLIC_AWS_S3=${{ secrets.NEXT_PUBLIC_AWS_S3 }}" >> .env.production
          echo "NEXT_PUBLIC_GTM_ID=${{ secrets.NEXT_PUBLIC_GTM_ID }}" >> .env.production
          echo "NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}" >> .env.production

      - name: Build and Push Client image
        if: |
          (github.event_name == 'push' && steps.changes.outputs.client == 'true') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_client == 'true')
        uses: docker/build-push-action@v5
        with:
          push: true
          context: .
          file: ./docker/client/Dockerfile
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/yogieat-client:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Nginx image
        if: |
          (github.event_name == 'push' && steps.changes.outputs.nginx == 'true') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_nginx == 'true')
        uses: docker/build-push-action@v5
        with:
          push: true
          file: ./docker/nginx/Dockerfile
          context: ./docker/nginx
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/yogieat-nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-application:
    needs: build-image
    runs-on: ubuntu-latest
    environment:
      name: development
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Copy docker-compose.yml to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "~/yogieat"

      - name: Deploy Project to Gabia Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            cd ~/yogieat

            # Pull latest images
            sudo docker compose pull

            # Restart only client-dev (ë¬´ì¤‘ë‹¨ ë°°í¬)
            sudo docker compose up -d --no-deps client-dev

            # Clean up unused images only (preserve volumes with SSL certificates)
            sudo docker image prune -a -f

            sudo docker compose ps

      - name: Restart Nginx if changed
        if: |
          (github.event_name == 'push' && needs.build-image.outputs.nginx_changed == 'true') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_nginx == 'true')
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            cd ~/yogieat
            sudo docker compose up -d --no-deps nginx

      - name: Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            cd ~/yogieat

            echo "ğŸ” Checking client container health..."

            # Configuration: start_period=40s, interval=30s
            # Max wait: 80s (40s grace + 30s check + 10s buffer)
            MAX_WAIT_TIME=80
            POLL_INTERVAL=10
            ELAPSED=0

            while [ $ELAPSED -lt $MAX_WAIT_TIME ]; do
              CLIENT_STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' yogieat-client-dev 2>/dev/null || echo "no-healthcheck")

              if [ "$CLIENT_STATUS" = "healthy" ] || [ "$CLIENT_STATUS" = "no-healthcheck" ]; then
                echo "âœ… Client container is healthy after ${ELAPSED}s"
                sudo docker compose ps
                exit 0
              elif [ "$CLIENT_STATUS" = "unhealthy" ]; then
                echo "âŒ Client container is unhealthy after ${ELAPSED}s"
                sudo docker compose ps
                echo ""
                echo "ğŸ“‹ Recent logs:"
                sudo docker compose logs --tail=100 client-dev
                exit 1
              else
                echo "â³ Client status: $CLIENT_STATUS (${ELAPSED}s/${MAX_WAIT_TIME}s)"
                sleep $POLL_INTERVAL
                ELAPSED=$((ELAPSED + POLL_INTERVAL))
              fi
            done

            echo "â±ï¸ Timeout: Container did not become healthy within ${MAX_WAIT_TIME}s"
            sudo docker compose ps
            echo ""
            echo "ğŸ“‹ Recent logs:"
            sudo docker compose logs --tail=100 client-dev
            exit 1

      - name: Extract commit info
        id: commit
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Discord notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ Development ë°°í¬"
          description: |
            **ìƒíƒœ**: ${{ job.status }}
            **íŠ¸ë¦¬ê±°**: ${{ github.event_name == 'workflow_dispatch' && 'ğŸ–±ï¸ ìˆ˜ë™ ë°°í¬' || 'ğŸ”„ ìë™ ë°°í¬' }}
            **ì»¤ë°‹**: [`${{ steps.commit.outputs.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **ë©”ì‹œì§€**: ${{ steps.commit.outputs.message }}
          color: ${{ job.status == 'success' && '0x57F287' || '0xED4245' }}
          username: GitHub Actions
