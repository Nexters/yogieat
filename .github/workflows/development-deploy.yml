name: Development Deployment

on:
  push:
    branches:
      - develop

jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            client:
              - 'app/**'
              - 'src/**'
              - 'public/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'docker/client/**'
              - 'next.config.js'
            nginx:
              - 'docker/nginx/**'

      - name: Login to DockerHub
        if: steps.changes.outputs.client == 'true' || steps.changes.outputs.nginx == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.changes.outputs.client == 'true' || steps.changes.outputs.nginx == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Create .env.production
        if: steps.changes.outputs.client == 'true'
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > .env.production
          echo "NEXT_PUBLIC_AWS_S3=${{ secrets.NEXT_PUBLIC_AWS_S3 }}" >> .env.production
          echo "NEXT_PUBLIC_GTM_ID=${{ secrets.NEXT_PUBLIC_GTM_ID }}" >> .env.production

      - name: Build and Push Client image
        if: steps.changes.outputs.client == 'true'
        uses: docker/build-push-action@v5
        with:
          push: true
          context: .
          file: ./docker/client/Dockerfile
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/yogieat-client:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Nginx image
        if: steps.changes.outputs.nginx == 'true'
        uses: docker/build-push-action@v5
        with:
          push: true
          file: ./docker/nginx/Dockerfile
          context: ./docker/nginx
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/yogieat-nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-application:
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Copy docker-compose.yml to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "~/yogieat"

      - name: Deploy Project to Gabia Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          script: |
            cd ~/yogieat

            sudo docker compose -f ./docker-compose.yml down
            # Clean up unused images only (preserve volumes with SSL certificates)
            sudo docker image prune -a -f

            sudo docker compose -f ./docker-compose.yml pull
            sudo docker compose -f ./docker-compose.yml up -d
            sudo docker compose -f ./docker-compose.yml ps

      - name: Extract commit info
        id: commit
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Discord notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ Development ë°°í¬"
          description: |
            **ìƒíƒœ**: ${{ job.status }}
            **ì»¤ë°‹**: [`${{ steps.commit.outputs.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **ë©”ì‹œì§€**: ${{ steps.commit.outputs.message }}
          color: ${{ job.status == 'success' && '0x57F287' || '0xED4245' }}
          username: GitHub Actions
